<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Accelerometer Demo</title>

        <style>
        .indicatorDot{
            width: 30px;
            height: 30px;
            background-color: #ffab56;
            border-radius: 50%;
            position:fixed;
        }
        </style>

    <script>

class BiquadBandpassFilter {
  constructor(sampleRate, centerFreq, Q) {
    this.sampleRate = sampleRate;
    this.centerFreq = centerFreq;
    this.Q = Q;

    // Internal state
    this.x1 = 0; this.x2 = 0;
    this.y1 = 0; this.y2 = 0;

    // Calculate filter coefficients
    this._calculateCoefficients();
  }

  _calculateCoefficients() {
    const omega = 2 * Math.PI * this.centerFreq / this.sampleRate;
    const alpha = Math.sin(omega) / (2 * this.Q);

    const b0 = alpha;
    const b1 = 0;
    const b2 = -alpha;
    const a0 = 1 + alpha;
    const a1 = -2 * Math.cos(omega);
    const a2 = 1 - alpha;

    // Normalize coefficients
    this.b0 = b0 / a0;
    this.b1 = b1 / a0;
    this.b2 = b2 / a0;
    this.a1 = a1 / a0;
    this.a2 = a2 / a0;
  }

  process(input) {
    // Direct Form I
    const output = this.b0 * input + this.b1 * this.x1 + this.b2 * this.x2
                                - this.a1 * this.y1 - this.a2 * this.y2;

    // Shift old samples
    this.x2 = this.x1;
    this.x1 = input;
    this.y2 = this.y1;
    this.y1 = output;

    return output;
  }
}

// Usage:
const filterX = new BiquadBandpassFilter(60, 5, 2); // 60Hz sample rate, 5Hz center, Q=1

const accelFilters = [
        new BiquadBandpassFilter(60, 5, 2),
        new BiquadBandpassFilter(60, 5, 2),
        new BiquadBandpassFilter(60, 5, 2),    
    ]
const rotFilters = [
        new BiquadBandpassFilter(60, 5, 2),
        new BiquadBandpassFilter(60, 5, 2),
        new BiquadBandpassFilter(60, 5, 2),    
    ]
const lastRot = {alpha:0,beta:0,gamma:0};
var px = 50; // Position x and y
var py = 50;
var vx = 0.0; // Velocity x and y
var vy = 0.0;
var updateRate = 1/60; // Sensor refresh rate

var lastDegrees = 0.0;
var shake = 0.0;
var lastRotationRateMagnitude = 0.0;
function getAccel(){
    const accelText = document.getElementById("accelText");
    const textOutput = document.getElementById("textOutput");

    DeviceMotionEvent.requestPermission().then(response => {
        accelText.innerText  = "---";
        accelText.innerText  = ":"+123;
        if (response == 'granted') {
       // Add a listener to get smartphone orientation 
           // in the alpha-beta-gamma axes (units in degrees)
            window.addEventListener('devicemotion',(event) => {
                var accel = event.acceleration;

                accel.x = accelFilters[0].process(accel.x)
                accel.y = accelFilters[1].process(accel.y)
                accel.z = accelFilters[2].process(accel.z)
                
                accelMagnitude = Math.sqrt(accel.x**2+accel.y**2+accel.z**2) * 20;
                accelText.innerHTML = "---------";

                dot = document.getElementsByClassName("indicatorDot")[0]
                dot.setAttribute('style', "top: 10%;left:" + (accelMagnitude) + "%;");

                var eventRot = event.rotationRate; 
                try{
                accelText.innerHTML = "eventRot: "+eventRot;
                var rot = {};
                rot.alpha = rotFilters[0].process((eventRot.alpha-lastRot.alpha)/updateRate)
                rot.beta = rotFilters[1].process((eventRot.beta-lastRot.beta)/updateRate)
                rot.gamma = rotFilters[2].process((eventRot.gamma-lastRot.gamma)/updateRate)
                accelText.innerHTML = "rot: "+rot;
                
                lastRot.alpha = eventRot.alpha;
                lastRot.beta = eventRot.beta;
                lastRot.gamma = eventRot.gamma;

                    
                accelText.innerHTML = "lastRot: "+lastRot;
                rotationRateMagnitude = Math.sqrt(rot.alpha**2 + rot.beta**2 + rot.gamma**2) / 20;
                dot = document.getElementsByClassName("indicatorDot")[1]
                dot.setAttribute('style', "top: 20%;left:" + (rotationRateMagnitude) + "%;");
                    accelText.innerHTML = ":"+rotationRateMagnitude;

                shake = shake * 0.97 + 0.03 * (rotationRateMagnitude + accelMagnitude) * 2.0;

                var shakeShow = Math.round(shake);

                accelText.innerText = "linear: "+accelMagnitude + "\nrotation: "+ rotationRateMagnitude;   
                textOutput.innerText = shakeShow;   

                dot = document.getElementsByClassName("indicatorDot")[2]
                dot.setAttribute('style', "top: 30%;left:" + (shake) + "%;");

                }
                catch(e)
                {
                    accelText.innerHTML = e;
                }
            });
            window.addEventListener('deviceorientation',(event) => {
                // Expose each orientation angle in a more readable way
                rotation_degrees = event.alpha;
                frontToBack_degrees = event.beta;
                leftToRight_degrees = event.gamma;


                
            });
        }
    });
}      
    </script>
    </head>
    <body style="background-color:lightblue;">
        <button id="accelPermsButton"  style="height:50px;" onclick="getAccel()"><h1>Get Accelerometer Permissions</h1></button>
        <div id="accelText" style="top:20px; left:10%">TEST 555</div>
        <div id="textOutput" style="font-size: 30vmin;left:50%; top:50%;height:50vmin;width:100%;text-align:center">123</div>        
        <div class="indicatorDot" style="left:30%; top:30%;"></div>
        <div class="indicatorDot" style="left:30%; top:30%;"></div>
        <div class="indicatorDot" style="left:30%; top:30%;"></div>
    </body>
</html>
