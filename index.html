<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Accelerometer Demo</title>

        <style>
        .indicatorDot{
            width: 30px;
            height: 30px;
            background-color: #ffab56;
            border-radius: 50%;
            position:fixed;
        }
        </style>

    <script>

class BiquadBandpassFilter {
  constructor(sampleRate, centerFreq, Q) {
    this.sampleRate = sampleRate;
    this.centerFreq = centerFreq;
    this.Q = Q;

    // Internal state
    this.x1 = 0; this.x2 = 0;
    this.y1 = 0; this.y2 = 0;

    // Calculate filter coefficients
    this._calculateCoefficients();
  }

  _calculateCoefficients() {
    const omega = 2 * Math.PI * this.centerFreq / this.sampleRate;
    const alpha = Math.sin(omega) / (2 * this.Q);

    const b0 = alpha;
    const b1 = 0;
    const b2 = -alpha;
    const a0 = 1 + alpha;
    const a1 = -2 * Math.cos(omega);
    const a2 = 1 - alpha;

    // Normalize coefficients
    this.b0 = b0 / a0;
    this.b1 = b1 / a0;
    this.b2 = b2 / a0;
    this.a1 = a1 / a0;
    this.a2 = a2 / a0;
  }

  process(input) {
    // Direct Form I
    const output = this.b0 * input + this.b1 * this.x1 + this.b2 * this.x2
                                - this.a1 * this.y1 - this.a2 * this.y2;

    // Shift old samples
    this.x2 = this.x1;
    this.x1 = input;
    this.y2 = this.y1;
    this.y1 = output;

    return output;
  }
}

// Usage:
const filterX = new BiquadBandpassFilter(60, 5, 2); // 60Hz sample rate, 5Hz center, Q=1

const accelText = document.getElementById("accelText");
        
var px = 50; // Position x and y
var py = 50;
var vx = 0.0; // Velocity x and y
var vy = 0.0;
var updateRate = 1/60; // Sensor refresh rate

var lastDegrees = 0.0;
var shake = 0.0;
function getAccel(){
    DeviceMotionEvent.requestPermission().then(response => {
        accelText.innerText  = "---";
        accelText.innerText  = ":"+123;
        if (response == 'granted') {
       // Add a listener to get smartphone orientation 
           // in the alpha-beta-gamma axes (units in degrees)
            window.addEventListener('devicemotion',(event) => {
                var accel = event.acceleration;
                accelMagnitude = Math.sqrt(accel.x**2+accel.y**2+accel.z**2);
                accelText.innerHTML = ":"+accelMagnitude;
            });
            window.addEventListener('deviceorientation',(event) => {
                // Expose each orientation angle in a more readable way
                rotation_degrees = event.alpha;
                frontToBack_degrees = event.beta;
                leftToRight_degrees = event.gamma;

                const filtered_degrees = filter.process(leftToRight_degrees);
                
                shake += Math.abs(filtered_degrees-lastDegrees) * updateRate * 100;
                lastDegrees = filtered_degrees;
                
                shake *= .99;
                
                
                // Update velocity according to how tilted the phone is
                // Since phones are narrower than they are long, double the increase to the x velocity
                vx = vx + leftToRight_degrees * updateRate*2; 
                vy = vy + frontToBack_degrees * updateRate;
                
                // Update position and clip it to bounds
                //px = px + vx*.5;
                px = shake;// px * 0.9 + (50.0 + vx* 10) * 0.1;
                if (px > 98 || px < 0){ 
                    px = Math.max(0, Math.min(98, px)) // Clip px between 0-98
                    vx = 0;
                }

                py = 50;// py + vy*.5;
                if (py > 98 || py < 0){
                    py = Math.max(0, Math.min(98, py)) // Clip py between 0-98
                    vy = 0;
                }
                
                dot = document.getElementsByClassName("indicatorDot")[0]
                dot.setAttribute('style', "left:" + (px) + "%;" +
                                              "top:" + (py) + "%;");
                
            });
        }
    });
}      
    </script>
    </head>
    <body style="background-color:lightblue;">
        <button id="accelPermsButton"  style="height:50px;" onclick="getAccel()"><h1>Get Accelerometer Permissions</h1></button>
        <div id="accelText" style="top:20px; left:10%">TEST 3</div>
        <div class="indicatorDot" style="left:30%; top:30%;"></div>
    </body>
</html>
